name: Test Unreal Engine Playbook

on:
  workflow_dispatch: # 手動実行用
  pull_request:      # PR作成時に自動テスト
    paths:
      - 'ansible/roles/unreal_engine/**'
      - 'ansible/co-location-development.yaml'

jobs:
  test-playbook:
    # Co-location環境内のSelf-Hosted Runnerを指定
    runs-on: [self-hosted, linux]
    
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ansible dependencies
        run: pip install ansible pywinrm

      - name: Syntax Check
        run: ansible-playbook -i co-location-development.yaml site.yaml --syntax-check

      - name: Dry Run (Check Mode)
        env:
          ARIES_PASSWORD: ${{ secrets.ARIES_PASSWORD }}
        run: |
          # --tags "github_actions": main.yml内でタグ付けされたタスクのみ実行
          # --check: 変更を加えないテストモード
          ansible-playbook -i co-location-development.yaml site.yaml --tags "github_actions" --check --diff --extra-vars "aries_password=$ARIES_PASSWORD"
