---
- name: Windows setup (GitHub Actions test)
  hosts: windows
  gather_facts: no

  vars:
    login_user: runneradmin

  tasks:
    - name: Create work directory
      ansible.windows.win_file:
        path: C:\WORK
        state: directory

    - name: Set timezone to JST
      community.windows.win_timezone:
        timezone: "Tokyo Standard Time"

    - name: Set environment variable (test)
      ansible.windows.win_environment:
        state: present
        name: TEST_ENV
        value: github-actions
        level: machine

    - name: Set PATH (test)
      ansible.windows.win_path:
        name: PATH
        elements:
          - C:\WORK
        state: present
      register: path_result

    - name: Create test PowerShell script
      ansible.windows.win_copy:
        dest: C:\WORK\test.ps1
        content: |
          Write-Output "Hello from GitHub Actions"
          Write-Output "User: {{ login_user }}"

    - name: Execute test PowerShell script
      ansible.windows.win_shell: |
        powershell.exe -ExecutionPolicy Bypass -File C:\WORK\test.ps1

    - name: Create dummy directory on Desktop
      ansible.windows.win_file:
        path: C:\Users\{{ login_user }}\Desktop\ansible-test
        state: directory

    - name: Copy dummy file
      ansible.windows.win_copy:
        dest: C:\Users\{{ login_user }}\Desktop\ansible-test\test.txt
        content: |
          This is a GitHub Actions test.
          Ansible is working.

    - name: Clean up work directory
      ansible.windows.win_file:
        path: C:\WORK
        state: absent
